/* @license
 * Copyright (c) 2019-2020, lengyanyu258 (lengyanyu258@outlook.com)
 * Released under the BSD-2-Clause license
 * https://github.com/lengyanyu258/xiangqi.js/blob/master/LICENSE
 */
"use strict";const Xiangqi=function(e){const n="rnbakabnr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RNBAKABNR r - - 0 1",t=Object.freeze(["1-0","0-1","1/2-1/2","*"]),r=Object.freeze({b:[16,-1,1],r:[-16,-1,1]}),i=Object.freeze({c:[-16,16,-1,1],r:[-16,16,-1,1],n:[-33,-31,31,33,-18,14,-14,18],b:[-34,34,30,-30],a:[-17,17,15,-15],k:[-16,16,-1,1]}),o=Object.freeze({NORMAL:"n",CAPTURE:"c"}),u=Object.freeze({NORMAL:1,CAPTURE:2}),s=Object.freeze({a9:0,b9:1,c9:2,d9:3,e9:4,f9:5,g9:6,h9:7,i9:8,a8:16,b8:17,c8:18,d8:19,e8:20,f8:21,g8:22,h8:23,i8:24,a7:32,b7:33,c7:34,d7:35,e7:36,f7:37,g7:38,h7:39,i7:40,a6:48,b6:49,c6:50,d6:51,e6:52,f6:53,g6:54,h6:55,i6:56,a5:64,b5:65,c5:66,d5:67,e5:68,f5:69,g5:70,h5:71,i5:72,a4:80,b4:81,c4:82,d4:83,e4:84,f4:85,g4:86,h4:87,i4:88,a3:96,b3:97,c3:98,d3:99,e3:100,f3:101,g3:102,h3:103,i3:104,a2:112,b2:113,c2:114,d2:115,e2:116,f2:117,g2:118,h2:119,i2:120,a1:128,b1:129,c1:130,d1:131,e1:132,f1:133,g1:134,h1:135,i1:136,a0:144,b0:145,c0:146,d0:147,e0:148,f0:149,g0:150,h0:151,i0:152});let l=new Array(256),f={r:-1,b:-1},c="r",a=0,p=1,h=[],d=[],b={};function g(e){void 0===e&&(e=!1),l=new Array(256),f={r:-1,b:-1},c="r",a=0,p=1,h=[],d=[],e||(b={}),A(q())}function m(){y(n)}function y(e,n){if(void 0===n&&(n=!1),!v(e).valid)return!1;let t,r,i=e.split(/\s+/),o=i[0],u=0;g(n);for(let e=0;e<o.length;++e)t=o.charAt(e),"/"===t?u+=7:-1!=="0123456789".indexOf(t)?u+=parseInt(t,10):(r=t<"a"?"r":"b",N({type:t.toLowerCase(),color:r},F(u)),u++);return c=i[1],a=parseInt(i[4],10),p=parseInt(i[5],10),A(q()),!0}function v(e){const n={0:"No errors.",1:"FEN string must contain six space-delimited fields.",2:"6th field (move number) must be a positive integer.",3:"5th field (half move counter) must be a non-negative integer.",4:"4th field (en-passant square) should be '-'.",5:"3rd field (castling availability) should be '-'.",6:"2nd field (side to move) is invalid.",7:"1st field (piece positions) does not contain 10 '/'-delimited rows.",8:"1st field (piece positions) is invalid [consecutive numbers].",9:"1st field (piece positions) is invalid [invalid piece].",10:"1st field (piece positions) is invalid [row too large].",11:"1st field (piece positions) is invalid [each side has one king].",12:"1st field (piece positions) is invalid [each side has no more than 2 advisers].",13:"1st field (piece positions) is invalid [each side has no more than 2 bishops].",14:"1st field (piece positions) is invalid [each side has no more than 2 knights].",15:"1st field (piece positions) is invalid [each side has no more than 2 rooks].",16:"1st field (piece positions) is invalid [each side has no more than 2 cannons].",17:"1st field (piece positions) is invalid [each side has no more than 5 pawns].",18:"1st field (piece positions) is invalid [king should at palace].",19:"1st field (piece positions) is invalid [red adviser should at right position].",20:"1st field (piece positions) is invalid [black adviser should at right position].",21:"1st field (piece positions) is invalid [red bishop should at right position].",22:"1st field (piece positions) is invalid [black bishop should at right position].",23:"1st field (piece positions) is invalid [red pawn should at right position].",24:"1st field (piece positions) is invalid [black pawn should at right position]."};function t(e){return{valid:0===e,error_number:e,error:n[e]}}const r=e.split(/\s+/);if(6!==r.length)return t(1);if(isNaN(r[5])||parseInt(r[5],10)<=0)return t(2);if(isNaN(r[4])||parseInt(r[4],10)<0)return t(3);if(!/^-$/.test(r[3]))return t(4);if(!/^-$/.test(r[2]))return t(5);if(!/^([rb])$/.test(r[1]))return t(6);const i=r[0].split("/");if(10!==i.length)return t(7);const o={p:{number:0,squares:[]},P:{number:0,squares:[]},c:{number:0,squares:[]},C:{number:0,squares:[]},r:{number:0,squares:[]},R:{number:0,squares:[]},n:{number:0,squares:[]},N:{number:0,squares:[]},b:{number:0,squares:[]},B:{number:0,squares:[]},a:{number:0,squares:[]},A:{number:0,squares:[]},k:{number:0,squares:[]},K:{number:0,squares:[]}};let u,s,l;for(u=0;u<i.length;u++){s=0,l=!1;for(let e=0;e<i[u].length;e++)if(isNaN(i[u][e])){try{++o[i[u][e]].number}catch(e){return t(9)}o[i[u][e]].squares.push(9-u<<4|s),s+=1,l=!1}else{if(l)return t(8);s+=parseInt(i[u][e],10),l=!0}if(9!==s)return t(10)}if(1!==o.k.number||1!==o.K.number)return t(11);if(o.a.number>2||o.A.number>2)return t(12);if(o.b.number>2||o.B.number>2)return t(13);if(o.n.number>2||o.N.number>2)return t(14);if(o.r.number>2||o.R.number>2)return t(15);if(o.c.number>2||o.C.number>2)return t(16);if(o.p.number>5||o.P.number>5)return t(17);if(G("k",o.k.squares[0],"r")||G("k",o.K.squares[0],"b"))return t(18);for(u=0;u<o.a.squares.length;++u)if(G("a",o.a.squares[u],"r"))return t(19);for(u=0;u<o.A.squares.length;++u)if(G("a",o.A.squares[u],"b"))return t(20);for(u=0;u<o.b.squares.length;++u)if(G("b",o.b.squares[u],"r"))return t(21);for(u=0;u<o.B.squares.length;++u)if(G("b",o.B.squares[u],"b"))return t(22);for(u=0;u<o.p.squares.length;++u)if(G("p",o.p.squares[u],"r"))return t(23);for(u=0;u<o.P.squares.length;++u)if(G("p",o.P.squares[u],"b"))return t(24);return t(0)}function q(){let e,n,t=0,r="";for(let i=s.a9;i<=s.i0;++i)null==l[i]?t++:(t>0&&(r+=t,t=0),e=l[i].color,n=l[i].type,r+="r"===e?n.toUpperCase():n.toLowerCase()),T(i)>=8&&(t>0&&(r+=t),i!==s.i0&&(r+="/"),t=0,i+=7);return[r,c,"-","-",a,p].join(" ")}function k(e){for(let n=0;n<e.length;n+=2)"string"==typeof e[n]&&"string"==typeof e[n+1]&&(b[e[n]]=e[n+1]);return b}function A(e){h.length>0||(e!==n?b.FEN=e:delete b.FEN)}function w(e){const n=l[s[e]];return n?{type:n.type,color:n.color}:null}function N(e,n){if(!("type"in e)||!("color"in e))return!1;if(-1==="pcrnbakPCRNBAK".indexOf(e.type.toLowerCase()))return!1;if(!(n in s))return!1;const t=s[n];return("k"!==e.type||-1===f[e.color]||f[e.color]===t)&&(!G(e.type,t,e.color)&&(l[t]={type:e.type,color:e.color},"k"===e.type&&(f[e.color]=t),A(q()),!0))}function R(e){function n(e,n,t,r,i){n.push(function(e,n,t,r){let i={color:c,from:n,to:t,flags:r,piece:e[n].type};return e[t]&&(i.captured=e[t].type),i}(e,t,r,i))}let t=[],o=c,f=S(o),a=s.a9,p=s.i0;const h=void 0===e||!("legal"in e)||e.legal,d=void 0!==e&&"opponent"in e&&e.opponent;if(void 0!==e&&"square"in e){if(!(e.square in s))return[];a=p=s[e.square]}let b,g,m,y,v,q,k,A;for(d&&(c=S(c),o=c,f=S(o)),b=a;b<=p;++b)if(y=l[b],null!=y&&y.color===o){for(v="p"===y.type?r[o]:i[y.type],g=0,m=v.length;g<m&&(!("p"===y.type&&g>0)||M(b,o));++g)for(q=v[g],k=b,A=!1;!(k+=q,X(k)||"n"===y.type&&Z(b,g)||"b"===y.type&&(D(b,g)||M(k,o))||("a"===y.type||"k"===y.type)&&G(y.type,k,o));){if(null==l[k]){if("c"===y.type&&A)continue;n(l,t,b,k,u.NORMAL)}else{if("c"!==y.type){l[k].color===f&&n(l,t,b,k,u.CAPTURE);break}if(A){l[k].color===f&&n(l,t,b,k,u.CAPTURE);break}A=!0}if("c"!==y.type&&"r"!==y.type)break}T(b)>=8&&(b+=7)}if(!h)return t;let w=[];for(b=0,m=t.length;b<m;b++)$(t[b]),P(o)||w.push(t[b]),K();return d&&(c=S(c)),w}function _(e,n){let t="";return t=F(e.from)+F(e.to),t}function O(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function P(e){let n,t,o,u=f[e],s=S(e);for(n=0,t=i.n.length;n<t;++n)if(o=u+i.n[n],null!=l[o]&&!X(o)&&l[o].color===s&&"n"===l[o].type&&!Z(o,n<4?3-n:11-n))return!0;for(n=0,t=i.r.length;n<t;++n){let e=i.r[n],t=!1;for(o=u+e;!X(o);o+=e){let e=l[o];if(null!=e){if(e.color===s)if(t){if("c"===e.type)return!0}else if("r"===e.type||"k"===e.type)return!0;if(t)break;t=!0}}}for(n=0,t=r[s].length;n<t;++n)if(o=u-r[s][n],null!=l[o]&&!X(o)&&l[o].color===s&&"p"===l[o].type)return!0;return!1}function C(){return P(c)}function j(){return C()&&0===R().length}function E(){return!C()&&0===R().length}function x(){let e,n={},t=0;for(let r in s)s.hasOwnProperty(r)&&(e=l[s[r]],e&&(n[e.type]=e.type in n?n[e.type]+1:1,t++));return 2===t||void 0===n.n&&void 0===n.r&&void 0===n.c&&void 0===n.p}function I(){let e,n=[],t={},r=!1;for(;e=K(),e;)n.push(e);for(;;){let e=q().split(" ").slice(0,2).join(" ");if(t[e]=e in t?t[e]+1:1,t[e]>=3&&(r=!0),!n.length)break;$(n.pop())}return r}function L(e,n){e.push({move:n,kings:{b:f.b,r:f.r},turn:c,half_moves:a,move_number:p})}function $(e){L(h,e),null!=l[e.to]&&"k"===l[e.to].type&&(f[l[e.to].color]=-1),l[e.to]=l[e.from],l[e.from]=null,"k"===l[e.to].type&&(f[l[e.to].color]=e.to),e.flags&u.CAPTURE?a=0:a++,"b"===c&&p++,c=S(c)}function B(e,n=!0){if(null==e)return null;const t=e.move;return f=e.kings,c=e.turn,a=e.half_moves,p=e.move_number,l[t.from]=l[t.to],l[t.from].type=t.piece,l[t.to]=null,(t.flags&u.CAPTURE)>0&&n&&(l[t.to]={type:t.captured,color:S(c)}),t}function K(){return B(h.pop())}function U(e,n){let t,r,i,o=O(e),u=o.match(/([a-iA-I][0-9])-?([a-iA-I][0-9])/);n&&u&&(t=u[1],r=u[2],i=u[3]);let l=R();for(let e=0,f=l.length;e<f;e++){if(o===O(_(l[e]))||n&&o===O(_(l[e])))return l[e];if(u&&(!t||t.toLowerCase()===l[e].piece)&&s[r]===l[e].from&&s[i]===l[e].to)return l[e]}return null}function z(e){return e>>4}function T(e){return 15&e}function F(e){const n=T(e),t=z(e);return"abcdefghi".substring(n,n+1)+"9876543210".substring(t,t+1)}function S(e){return"r"===e?"b":"r"}function M(e,n){return"r"===n?z(e)<5:z(e)>4}function X(e){return e<0||z(e)>9||T(e)>8}function G(e,n,t){let r={};if("p"===e)return r=[0,2,4,6,8],"r"===t?z(n)>6||z(n)>4&&-1===r.indexOf(T(n)):z(n)<3||z(n)<5&&-1===r.indexOf(T(n));if("b"===e)r.r=[146,150,112,116,120,82,86],r.b=[2,6,32,36,40,66,70];else if("a"===e)r.r=[147,149,132,115,117],r.b=[3,5,20,35,37];else{if("k"!==e)return X(n);r.r=[147,148,149,131,132,133,115,116,117],r.b=[3,4,5,19,20,21,35,36,37]}return-1===r[t].indexOf(n)}function Z(e,n){return null!=l[e+[-16,16,-1,1][Math.floor(n/2)]]}function D(e,n){return null!=l[e+[-17,17,15,-15][n]]}function H(e){let n=function e(n){let t=n instanceof Array?[]:{};for(let r in n)t[r]="object"==typeof r?e(n[r]):n[r];return t}(e);n.iccs=_(n),n.to=F(n.to),n.from=F(n.from);let t="";for(let e in u)(u[e]&n.flags)>0&&(t+=o[e]);return n.flags=t,n}function Q(e){return e.replace(/^\s+|\s+$/g,"")}return y(void 0===e?n:e),{RED:"r",BLACK:"b",PAWN:"p",CANNON:"c",ROOK:"r",KNIGHT:"n",BISHOP:"b",ADVISER:"a",KING:"k",SQUARES:function(){let e=[];for(let n=s.a9;n<=s.i0;n++)9!==T(n)?e.push(F(n)):n+=6;return e}(),FLAGS:o,load:function(e){return y(e)},reset:function(){return m()},moves:function(e){const n=R(e);let t=[];for(let r=0,i=n.length;r<i;r++)void 0!==e&&"verbose"in e&&e.verbose?t.push(H(n[r])):t.push(_(n[r]));return t},in_check:function(){return C()},in_checkmate:function(){return j()},in_stalemate:function(){return E()},in_draw:function(){return a>=120||I()||x()},insufficient_material:function(){return x()},in_threefold_repetition:function(){return I()},game_over:function(){return a>=120||j()||E()||x()||I()||-1===f[S(c)]},validate_fen:function(e){return v(e)},fen:function(){return q()},board:function(){let e=[],n=[];for(let t=s.a9;t<=s.i0;t++)null==l[t]?n.push(null):n.push({type:l[t].type,color:l[t].color}),8&t&&(e.push(n),n=[],t+=7);return e},pgn:function(e){let n,t="object"==typeof e&&"string"==typeof e.newline_char?e.newline_char:"\n",r="object"==typeof e&&"number"==typeof e.max_width?e.max_width:0,i=[],o=!1;for(n in b)i.push("["+n+' "'+b[n]+'"]'+t),o=!0;o&&h.length&&i.push(t);let u=[];for(;h.length>0;)u.push(K());let s=[],l="";for(;u.length>0;){let e=u.pop();h.length||"b"!==e.color?"b"!==e.color&&(l.length&&s.push(l),l=p+"."):l=p+". ...",l=l+" "+_(e),$(e)}if(l.length&&s.push(l),void 0!==b.Result&&s.push(b.Result),0===r)return i.join("")+s.join(" ");let f=0;for(n=0;n<s.length;n++)f+s[n].length>r&&0!==n?(" "===i[i.length-1]&&i.pop(),i.push(t),f=0):0!==n&&(i.push(" "),f++),i.push(s[n]),f+=s[n].length;return i.join("")},load_pgn:function(e,n){let r=void 0!==n&&"sloppy"in n&&n.sloppy;function i(e){return e.replace(/\\/g,"\\")}const o="object"==typeof n&&"string"==typeof n.newline_char?n.newline_char:"\r?\n",u=new RegExp("^(\\[((?:"+i(o)+")|.)*\\])(?:"+i(o)+"){2}"),s=u.test(e)?u.exec(e)[1]:"";m();const l=function(e,n){let t="object"==typeof n&&"string"==typeof n.newline_char?n.newline_char:"\r?\n",r={},o=e.split(new RegExp(i(t))),u="",s="";for(let e=0;e<o.length;e++)u=o[e].replace(/^\[([A-Z][A-Za-z]*)\s.*]$/,"$1"),s=o[e].replace(/^\[[A-Za-z]+\s"(.*)"]$/,"$1"),Q(u).length>0&&(r[u]=s);return r}(s,n);for(let e in l)l.hasOwnProperty(e)&&k([e,l[e]]);if("FEN"in l&&!y(l.FEN,!0))return!1;let f=e.replace(s,"").replace(new RegExp(i(o),"g")," ");f=f.replace(/({[^}]+})+?/g,"");const c=/(\([^()]+\))+?/g;for(;c.test(f);)f=f.replace(c,"");f=f.replace(/\d+\.(\.\.)?/g,""),f=f.replace(/\.\.\./g,""),f=f.replace(/\$\d+/g,"");let a=Q(f).split(new RegExp(/\s+/));a=a.join(",").replace(/,,+/g,",").split(",");let p="";for(let e=0;e<a.length-1;e++){if(p=U(a[e],r),null==p)return!1;$(p)}if(p=a[a.length-1],t.indexOf(p)>-1)(function(e){for(let n in e)if(e.hasOwnProperty(n))return!0;return!1})(b)&&void 0===b.Result&&k(["Result",p]);else{if(p=U(p,r),null==p)return!1;$(p)}return!0},header:function(){return k(arguments)},ascii:function(){return function(){let e="   +---------------------------+\n";for(let n=s.a9;n<=s.i0;n++){if(0===T(n)&&(e+=" "+"9876543210"[z(n)]+" |"),null==l[n])e+=" . ";else{let t=l[n].type;e+=" "+("r"===l[n].color?t.toUpperCase():t.toLowerCase())+" "}8&n&&(e+="|\n",n+=7)}return e+="   +---------------------------+\n",e+="     a  b  c  d  e  f  g  h  i\n",e}()},turn:function(){return c},move:function(e,n){const t=void 0!==n&&"sloppy"in n&&n.sloppy;let r=null;if("string"==typeof e)r=U(e,t);else if("object"==typeof e){let n=R();for(let t=0,i=n.length;t<i;t++)if(e.from===F(n[t].from)&&e.to===F(n[t].to)&&!(""in n[t])){r=n[t];break}}if(!r)return null;const i=H(r);return $(r),d=[],i},undo:function(){L(d,null);const e=K();if(e){const n=H(e);return[e.from,e.to]=[e.to,e.from],d[d.length-1].move=e,n}return d.pop(),null},redo:function(){L(h,null);const e=B(d.pop(),!1);return e?([e.from,e.to]=[e.to,e.from],h[h.length-1].move=e,H(e)):(h.pop(),null)},clear:function(){return g()},put:function(e,n){return N(e,n)},get:function(e){return w(e)},remove:function(e){return function(e){const n=w(e);return l[s[e]]=null,n&&"k"===n.type&&(f[n.color]=-1),A(q()),n}(e)},perft:function(e){return function e(n){const t=R({legal:!1});let r=0;for(let i=0,o=t.length;i<o;i++){if($(t[i]),!P(c))if(n-1>0){r+=e(n-1)}else r++;K()}return r}(e)},history:function(e){let n=[],t=[],r=void 0!==e&&"verbose"in e&&e.verbose;for(;h.length>0;)n.push(K());for(;n.length>0;){let e=n.pop();r?t.push(H(e)):t.push(_(e)),$(e)}return t}}};"undefined"!=typeof exports&&(exports.Xiangqi=Xiangqi),"undefined"!=typeof define&&define((function(){return Xiangqi}));